{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-lg-8 mx-auto text-center">
      <h1 class="display-5 text-primary mb-3">
        <i class="fa-solid fa-hand-holding-hand"></i>
        Mental Health Screening App
      </h1>
      <p class="lead text-muted">
        Agentic-AI assisted Screening of Anxiety, Depression and Pyschosis.
      </p>
    </div>
  </div>

  <!-- Auth Gate -->
  <div id="auth-gate" class="py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-sm-10 col-md-7 col-lg-5">
          <div id="auth-error" class="alert alert-danger d-none" role="alert"></div>

          <!-- LOGIN -->
          <div id="login-card" class="card shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title mb-3">Welcome back</h4>
              <form id="login-form" novalidate>
                <div class="mb-3">
                  <label for="login-email" class="form-label">Email</label>
                  <input type="email" id="login-email" class="form-control" autocomplete="username" required>
                </div>
                <div class="mb-3">
                  <label for="login-password" class="form-label">Password</label>
                  <input type="password" id="login-password" class="form-control" autocomplete="current-password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Log in</button>
              </form>
              <div class="text-center mt-3">
                <small class="text-muted">No account?</small>
                <button class="btn btn-link p-0 align-baseline" data-action="show-signup">Create one</button>
              </div>
            </div>
          </div>

          <!-- SIGNUP -->
          <div id="signup-card" class="card shadow-sm d-none mt-3 mt-md-4">
            <div class="card-body p-4">
              <h4 class="card-title mb-3">Create your account</h4>
              <form id="signup-form" novalidate>
                <div class="mb-3">
                  <label for="signup-email" class="form-label">Email</label>
                  <input type="email" id="signup-email" class="form-control" autocomplete="email" required>
                </div>
                <div class="mb-3">
                  <label for="signup-password" class="form-label">Password</label>
                  <input type="password" id="signup-password" class="form-control" autocomplete="new-password" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Sign up</button>
              </form>
              <div class="text-center mt-3">
                <small class="text-muted">Already have an account?</small>
                <button class="btn btn-link p-0 align-baseline" data-action="show-login">Log in</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="app-wrapper" style="display:none;">
    <nav class="navbar navbar-expand-lg navbar-light bg-light rounded shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Question-Recommender</a>
        <div class="d-flex ms-auto align-items-center gap-3">
          <span id="whoami" class="navbar-text text-muted"></span>
        </div>
      </div>
    </nav>
  </div>

  {% if current_user.is_authenticated %}

  <!-- Question Bank -->
  <div class="row mb-4">
    <div class="col-lg-15 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="mb-3">Question Bank</h4>
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Category</label>
              <select id="qbCategory" class="form-select">
                <option value="">All</option>
                <option value="depression">Depression</option>
                <option value="anxiety">Anxiety</option>
                <option value="psychosis">Psychosis</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Search within category</label>
              <input id="qbQuery" class="form-control" placeholder="e.g., hopeless, panic, voices">
            </div>
            <div class="col-md-4 d-flex gap-2">
              <button id="qbSearchBtn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i> Search
              </button>
              <button id="qbPrintBtn" class="btn btn-outline-secondary w-100" disabled>
                <i class="fas fa-print me-1"></i> Print
              </button>
              <button id="qbExportBtn" class="btn btn-outline-success w-100" disabled>
                <i class="fas fa-file-export me-1"></i> Export CSV
              </button>
            </div>
          </div>

          <div id="qbResults" class="mt-3">
            <div class="text-muted">Search to see questions.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agents Conversation -->
  <div class="row mb-4">
    <div class="col-lg-15 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="container mt-2" id="agentsConversation">

            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <h2 class="m-0">Agents Conversation</h2>

              <div class="d-flex align-items-center gap-2 flex-wrap">
                <label for="chatMode" class="form-label m-0">Mode</label>
                <select id="chatMode" class="form-select form-select-sm" style="width:auto;">
                  <option value="real" selected>Real Actors</option>
                  <option value="simulated">Simulated</option>
                  <option value="live">Live (Mic)</option>
                </select>

                <label for="languageMode" class="form-label m-0">Language</label>
                <select id="languageMode" class="form-select form-select-sm" style="width:auto;">
                  <option value="bilingual" selected>English &amp; Swahili</option>
                  <option value="english">English Only</option>
                  <option value="swahili">Swahili Only</option>
                </select>

                <span id="modeBadge" class="badge rounded-pill mode-badge">Real Actors</span>
                <button type="button" id="resetBtn" class="btn btn-outline-danger btn-sm">Reset Conversation</button>
              </div>
            </div>

            <div class="alert p-2 mb-3 mode-tip" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              <span id="modeTipText">Turn-based chat: alternate between Clinician and Patient.</span>
            </div>

            <!-- Turn-based Pane -->
            <div id="turnPane">
              <div id="roleSelector" class="mb-2 d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Role selector">
                  <button type="button" id="roleClinicianBtn" class="btn btn-primary">Clinician</button>
                  <button type="button" id="rolePatientBtn" class="btn btn-secondary">Patient</button>
                </div>
                <span id="currentRoleDisplay" class="text-muted">(Current: Clinician)</span>
              </div>

              <form id="agentChatForm" class="card shadow-sm">
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-9">
                      <label for="agentMessage" class="form-label">Message</label>
                      <input type="text" id="agentMessage" class="form-control"
                             placeholder="Say something to the doctor..." required>
                    </div>

                    <div class="col-md-3">
                      <div class="row g-2">
                        <div class="col-6">
                          <button type="button" id="recordAudioBtn" class="btn btn-outline-secondary btn-sm w-100 text-truncate" title="Record Voice Note">
                            ðŸŽ¤ Voice Note
                          </button>
                        </div>
                        <div class="col-6">
                          <button type="submit" class="btn btn-success btn-sm w-100">
                            Send
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <audio id="recordedAudio" class="mt-2 w-100" controls style="display:none;"></audio>
                  <div id="typingIndicator" class="text-muted fst-italic mt-2" style="display:none;">Typing...</div>
                </div>
              </form>

              <div class="card shadow-sm mt-3">
                <div class="card-header bg-light"><strong>Transcript</strong></div>
                <div class="card-body p-3">
                  <div id="agentChatTranscript" class="transcript-box"></div>
                </div>
              </div>

              <div class="card shadow-sm mt-3">
                <div class="card-header bg-light"><strong>Suggested Questions</strong></div>
                <div class="card-body p-2">
                  <ul id="chatSuggestedQuestions" class="mb-0"></ul>
                </div>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <button type="button" id="finalizeBtn" class="btn btn-outline-primary">
                  Summarize &amp; Final Plan
                </button>
              </div>
            </div>

            <!-- Live (Mic) Pane -->
            <div id="livePane" style="display:none;">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                <h2 class="m-0">Live Transcription</h2>
                <span class="badge rounded-pill bg-secondary">Mic Mode</span>
              </div>

              <div class="alert p-2 mb-3" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Speak normally. Youâ€™ll see partials while you speak; finals after short pauses.
              </div>

              <div id="liveBar" class="d-flex gap-2 align-items-center mb-2">
                <button id="startLiveBtn" type="button" class="btn btn-sm btn-primary">â–¶ Start Live</button>
                <button id="stopLiveBtn"  type="button" class="btn btn-sm btn-danger" disabled>â–  Stop</button>
                <span id="liveStatus" class="ms-2 text-muted"></span>
              </div>

              <div class="card shadow-sm mb-3">
                <div class="card-header bg-light"><strong>Live Line</strong></div>
                <div class="card-body">
                  <div id="liveMessage" class="form-control" style="min-height:52px;"></div>
                  <small class="text-muted">Partials appear here.</small>
                </div>
              </div>

              <div class="card shadow-sm mb-3">
                <div class="card-header bg-light"><strong>Transcript (Finals)</strong></div>
                <div class="card-body p-3">
                  <div id="liveTranscript" class="transcript-box"></div>
                </div>
              </div>

              <div class="card shadow-sm mb-3">
                <div class="card-header bg-light d-flex align-items-center justify-content-between gap-2">
                  <strong>Suggested Questions</strong>
                  <div class="d-flex align-items-center gap-2">
                    <button id="show-unasked-btn" type="button" class="btn btn-sm btn-outline-secondary">
                      Unasked <span class="badge bg-secondary ms-1" id="unasked-badge">0</span>
                    </button>
                    <button id="clear-suggested-btn" type="button" class="btn btn-sm btn-outline-danger">
                      Clear Suggested
                    </button>
                  </div>
                </div>
                <div class="card-body p-2">
                  <ul id="liveSuggestedQuestions" class="mb-0"></ul>
                </div>
              </div>
            </div>

            <!-- Unasked modal -->
            <div class="modal fade" id="unaskedModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Unasked Questions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="unasked-list"></div>
                  <div class="modal-footer">
                    <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>

          </div> <!-- /agentsConversation -->
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Results Section -->
  <div id="resultsSection" class="mt-4" style="display:none;">
    <h3>Search Results</h3>
    <div id="resultsContainer"></div>

    <h4 class="mt-4">Suggested Questions (English & Swahili)</h4>
    <ul id="suggestedQuestions"></ul>
  </div>
</div>
{% endblock %}
